<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="
    	http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    	http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
    ">
    
    <changeSet id="create-etl-history" author="rhayes">
    	<createTable tableName="etl_history">
    		<column name="id" type="integer" autoIncrement="true" >
    			<constraints primaryKey="true"/>
    		</column>
    		<column name="archive_id" type="integer">
    		</column>
    		<column name="ts" type="timestamp"/>
    		<column name="outcome" type="varchar(255)" />
    	</createTable>
    	<addForeignKeyConstraint constraintName="fkEtlHistory" 
    		referencedTableName="archive_config" referencedColumnNames="id"
    		baseTableName="etl_history" baseColumnNames="archive_id" 
    	/>
    </changeSet>
    
    <changeSet id="etl-history-trigger" author="rhayes">
    	<sql>
    		CREATE TRIGGER tg_set_time
  			AFTER INSERT ON ETL_HISTORY
			FOR EACH STATEMENT MODE DB2SQL
  			UPDATE ETL_HISTORY 
  			SET TS = CURRENT_TIMESTAMP
  			WHERE TS IS NULL;
    	</sql>
    	
    	<rollback>
    		DROP TRIGGER tg_set_time;
    	</rollback>
    </changeSet>
    
    <changeSet id="add-rfc-name" author="rhayes">
    	<addColumn tableName="archive_config">
    		<column name="name" type="char(4)"/>
    	</addColumn>
    </changeSet>
    
    <changeSet id="rfc-names-and-notes" author="rhayes">
    	<addColumn tableName="archive_config">
    		<column name="notes" type="varchar(255)"/>
    	</addColumn>
    
    	<update tableName="archive_config">
    		<column name="name" value="TSJU" />
    		<column name="notes" value="Puerto Rico"/>
    		<where>rfc_code = 105</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KTUA" />
    		<column name="notes" value="Arkansas"/>
    		<where>rfc_code = 150</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KSTR" />
    		<column name="notes" value="Colorado (mostly only 6hr data)"/>
    		<where>rfc_code = 152</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KRSA" />
    		<column name="notes" value="California (grouped in way difficult to work with)"/>
    		<where>rfc_code = 153</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KORN" />
    		<column name="notes" value="Lower Mississippi"/>
    		<where>rfc_code = 154</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KRHA" />
    		<column name="notes" value="Mid Atlantic"/>
    		<where>rfc_code = 155</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KKRF" />
    		<column name="notes" value="Missouri"/>
    		<where>rfc_code = 156</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KMSR" />
    		<column name="notes" value="North Central"/>
    		<where>rfc_code = 157</where>
    	</update>
    	
    	<update tableName="archive_config">
    		<column name="name" value="KTAR" />
    		<column name="notes" value="North East (grid changed 2005-04-20)"/>
    		<where>rfc_code = 158</where>
    	</update>
    	
    	<update tableName="archive_config">
    		<column name="name" value="KPTR" />
    		<column name="notes" value="North West (mostly 6 hr data)"/>
    		<where>rfc_code = 159</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KTIR" />
    		<column name="notes" value="Ohio (grid changed 2003-05-21)"/>
    		<where>rfc_code = 160</where>
    	</update>

    	<update tableName="archive_config">
    		<column name="name" value="KALR" />
    		<column name="notes" value="South East"/>
    		<where>rfc_code = 161</where>
    	</update>
    	
    	<update tableName="archive_config">
    		<column name="name" value="KFWR" />
    		<column name="notes" value="Gulf of Mexico"/>
    		<where>rfc_code = 162</where>
    	</update>

	<addNotNullConstraint tableName="archive_config" columnName="name"/>
		
	<rollback>
	  <dropColumn tableName="archive_config" columnName="name"/>
	  <dropColumn tableName="archive_config" columnName="notes"/>
	</rollback>
		
    </changeSet>
    
</databaseChangeLog>
